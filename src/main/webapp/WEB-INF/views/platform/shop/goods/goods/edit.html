<%
layout("/layouts/platform.html"){
%>
<style>
    #img{
        list-style-type: none;
        margin: 2px;
        height: 118px;
        float: left;
    }
    .divImg{
        float: left;
        margin: 2px;
        padding: 2px;
        height:108px;
        width:100px;
        border: 1px solid #dcdcdc;
        cursor: pointer;
    }
    .divImgD{
        float: left;
        margin: 2px;
        padding: 2px;
        height:108px;
        width:100px;
        border: 1px solid red;
        cursor: pointer;
    }
</style>
<script src="${base!}/assets/plugins/ueditor/ueditor.config.js"></script>
<script src="${base!}/assets/plugins/ueditor/ueditor.all.min.js"></script>
<header class="header navbar bg-white shadow">
    <div class="btn-group tool-button">
        <a class="btn btn-primary navbar-btn" href="${base!}/platform/shop/goods/goods" data-pjax><i class="ti-angle-left"></i> 返回</a>
    </div>
    <div class="pull-right">
        <div class="btn-group tool-button">
            <button class="btn btn-primary navbar-btn" type="button" id="save"> 保存</button>
        </div>
    </div>
</header>

<div class="content-wrap">
    <div class="wrapper" style="min-height:500px;">
        <form id="addForm" role="form" class="form-horizontal parsley-form" data-parsley-validate
              action="${base!}/platform/shop/goods/goods/editDo" method="post">
            <input type="hidden" name="id" id="id" value="${obj.id!}">
            <input type="hidden" name="isSubmit" id="isSubmit" value="0">
            <div class="box-tab tabs-left">
                <ul class="nav nav-tabs">
                    <li class="active"><a href="#base" data-toggle="tab">基本信息</a>
                    </li>
                    <li id="kzsx_tab" class="" style="display:<%if(!isEmpty(obj.goodsType)&&obj.goodsType.hasProp){%>block<%}else{%>none<%}%>;"><a href="#kzsx" data-toggle="tab">扩展属性</a>
                    </li>
                    <li id="xxcs_tab" class="" style="display: <%if(!isEmpty(obj.goodsType)&&obj.goodsType.hasParam){%>block<%}else{%>none<%}%>;"><a href="#xxcs" data-toggle="tab">详细参数</a>
                    </li>
                    <li class=""><a href="#inf" data-toggle="tab">商品介绍</a>
                    </li>
                </ul>
                <div class="tab-content text-center">
                    <div class="tab-pane fade active in" id="base">
                        <div class="row mb10">
                            <div class="col-lg-12">
                                <div class="form-group has-feedback">
                                    <label for="classId" class="col-sm-2 control-label">商品分类</label>

                                    <div class="col-sm-8">
                                        <div class="input-group">
                                            <input id="classId" type="text" class="form-control" placeholder="请选择商品分类" disabled
                                                   value="<%if(!isEmpty(obj.goodsClass)){%>${obj.goodsClass.name!}<%}%>"/>

			                             		<span class="input-group-btn">
			                             			<button type="button" class="btn btn-primary" data-toggle="modal"
                                                            data-target="#dialogSelectClass"><i class="ti-plus"></i>选择
                                                    </button>
			                             		</span>

                                        </div>
                                        <input type="hidden" name="classId" value="<%if(!isEmpty(obj.goodsClass)){%>${obj.goodsClass.id!}<%}%>">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="typeId" class="col-sm-2 control-label">商品类型</label>

                                    <div class="col-sm-8">
                                        <select id="typeId" name="typeId" class="form-control">
                                            <option value="">通用商品</option>
                                            <%for(o in typeList){%>
                                            <option value="${o.id!}" <%if(obj.typeId==o.id){%>selected<%}%>>${o.name!}</option>
                                            <%}%>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="name" class="col-sm-2 control-label"><span style="color: red">*</span>商品名称</label>

                                    <div class="col-sm-8">
                                        <input type="text" id="name" class="form-control" name="name" data-parsley-required="true"
                                               placeholder="商品名称" value="${obj.name!}"  data-parsley-maxlength="150">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="title" class="col-sm-2 control-label">商品标题</label>

                                    <div class="col-sm-8">
                                        <input type="text" id="title" class="form-control" name="title"
                                               placeholder="商品标题" value="${obj.title!}"  data-parsley-maxlength="150">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="brandId" class="col-sm-2 control-label">品牌</label>

                                    <div class="col-sm-8">
                                        <select id="brandId" name="brandId" class="form-control">
                                            <%for(o in brandList){%>
                                            <option value="${o.id!}" <%if(obj.brandId==o.id){%>selected<%}%>>${o.name!}</option>
                                            <%}%>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="file_upload" class="col-sm-2 control-label">商品相册</label>

                                    <div class="col-sm-8">
                                        <div id="queue"></div>
                                        <div >
                                            <input id="file_upload" name="file_upload" type="file" multiple="true">

                                        </div>
                                        <div id="img">
                                            <%if(!isEmpty(obj.imagesList)){
                                            var i=0;
                                            for(o in obj.imagesList){
                                            i++;
                                            var c="divImg";
                                            if(o.imgurl==obj.imgurl){
                                            c="divImgD";
                                            }
                                            %>
                                            <div id='imgId${i}' class='${c}'>
                                            <img  onclick="setImg('imgId${i}')" src='${o.imgurl!}' style='width:100px;height: 80px;margin-bottom: 1px;'><br>
                                            <i style='float: right;padding-top: 4px;' class='fa fa-close' onclick="delImg('imgId${i}')"></i></div>
                                            <%}}%>
                                        </div>
                                    </div>
                                </div>
                                <div id="sp_new" style="display: <%if(obj.hasSpec){%>block<%}else{%>none<%}%>;">
                                    <%if(obj.hasSpec){%>
                                   
                                    <div class="form-group" id="gg_new">
                                        <label for="gg_new" class="col-sm-2 control-label">规格</label>
                                        <div class="col-sm-8">
                                            <button id="specEditBtn" class="btn btn-primary" style="float: left;" type="button">编辑规格</button>
                                            <div style="float: left;text-align: left;">已设置${productNum!0}个规格货品[<%for(o in obj.productsList){%>${o.spec};<%}%>]</div>
                                        </div>
                                    </div>
                                    <%}%>
                                </div>
                                <div id="sp" style="display: <%if(!obj.hasSpec){%>block<%}else{%>none<%}%>;">

                                    <div class="form-group">
                                        <label for="price" class="col-sm-2 control-label">销售价</label>

                                        <div class="col-sm-8">
                                            <input type="text" id="price" class="form-control" value="${@string.fenToYuan(obj.productsList[0].price)}" style="width: 120px;" name="price" placeholder="销售价">
                                            <input type="hidden" name="lvprice" value="${@string.toJson(obj.productsList[0].lvPriceList),escape}">
                                            <%if(@lvList.size()>0){%>

                                            <button class="btn btn-primary" style="float: left;margin-top: 2px;" type="button" data-toggle="modal"
                                                    data-target="#dialogLv">编辑会员价格</button>
                                            <%}%>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="priceMarket" class="col-sm-2 control-label">市场价</label>

                                        <div class="col-sm-8">
                                            <input type="text" id="priceMarket" value="${@string.fenToYuan(obj.productsList[0].priceMarket)}" class="form-control" style="width: 120px;" name="priceMarket" placeholder="市场价">

                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="sku" class="col-sm-2 control-label">SKU货号</label>

                                        <div class="col-sm-8">
                                            <input type="text" id="sku" value="${obj.productsList[0].sku!}" class="form-control" name="sku" placeholder="货号(不填则自动生成)">

                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="weight" class="col-sm-2 control-label">重量</label>

                                        <div class="col-sm-8">
                                            <input type="text" id="weight" value="${obj.productsList[0].weight!}" class="form-control" style="width: 120px;" name="weight" placeholder="克(g)">

                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="stock" class="col-sm-2 control-label">库存</label>

                                        <div class="col-sm-8">
                                            <input type="text" id="stock" value="${obj.productsList[0].stock!}" class="form-control" style="width: 120px;" name="stock" placeholder="库存">

                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="buyMin" class="col-sm-2 control-label">最小购买量</label>

                                        <div class="col-sm-8">
                                            <input type="text" id="buyMin" class="form-control" style="width: 120px;" value="${obj.productsList[0].buyMin!}" name="buyMin" placeholder="默认为1">

                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="buyMax" class="col-sm-2 control-label">最大购买量</label>

                                        <div class="col-sm-8">
                                            <input type="text" id="buyMax" class="form-control" style="width: 120px;" value="${obj.productsList[0].buyMax!}"  name="buyMax" placeholder="默认为100">
                                        </div>
                                    </div>
                                    <div class="form-group" id="gg" style="display: none">
                                        <label for="gg" class="col-sm-2 control-label">规格</label>

                                        <div class="col-sm-8">
                                            <button id="specBtn" class="btn btn-primary" style="float: left;" type="button">开启规格</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="unit" class="col-sm-2 control-label">计量单位</label>

                                    <div class="col-sm-8">
                                        <input id="unit" type="text" value="${obj.productsList[0].unit!}" class="form-control" style="width: 120px;" name="unit" placeholder="计量单位">

                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="disabled1" class="col-sm-2 control-label">是否上架</label>

                                    <div id="disabled1" class="col-sm-8" style="float: left;text-align: left">
                                        <input type="radio" name="disabled" value="0" checked>上架
                                        <input type="radio" name="disabled" value="1">下架

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="kzsx">
                        <%for(prop in typePropList){
                        if(prop.type=='select') {
                        %>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">${prop.name!}</label>
                            <div class="col-sm-8">
                                <select class="form-control" >
                                    <option value=""></option>
                                    <%for(value in prop.propsValues){
                                    %>
                                    <option value="${value.name!}" >${value.name!}</option>
                                    <%
                                    }%>
                                </select>
                            </div>
                        </div>
                        <%
                        }else{
                        %>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">${prop.name!}</label>
                            <div class="col-sm-8">
                                <input class="form-control" value=""/>
                            </div>
                        </div>
                        <%

                        }%>

                        <%}%>
                        <script>
                            $(function(){
                                //初始化商品属性
                                var prop=${obj.prop!"[]"};
                                $.each(prop,function(i,o){
                                    $("#kzsx").find(".form-group").each(function(j,k){
                                        var self=$(this);
                                        if(self.find(".control-label").html()== o.name){
                                                self.find("input").val(o.value);
                                                self.find("select").val(o.value);
                                        }
                                    });
                                });
                            });
                        </script>
                    </div>
                    <div class="tab-pane fade" id="xxcs">
                        <%for(paramg in typeParamgList){%>
                        <div class="form-group">
                        <label class="col-sm-3 control-label">${paramg.name!}</label>
                        <%for(p in paramg.params){%>
                        <div class="col-sm-12" style="padding-bottom:5px;">
                            <div class="col-sm-10 input-group">
                                <span class="input-group-btn">
                                <button class="btn" style="width:120px;" type="button">${p.name!}</button>
                                </span>
                                <input type="text" class="form-control" placeholder="${p.name!}">
                            </div>
                        </div>
                        <%}%>
                         </div>
                        <%}%>
                        <script>
                            $(function(){
                                //初始化商品参数
                                var param=${obj.param!"[]"};
                                $.each(param,function(i,o){
                                    var name= o.name;
                                    $.each(o.value,function(j,k){
                                        $("#xxcs").find(".form-group").each(function(r,t){
                                            var self=$(this);
                                            if($(this).find(".control-label").html()== o.name){
                                                self.find(".input-group").each(function(n,m){
                                                    var obj=$(this);
                                                    if(obj.find("button").html()== k.name){
                                                        obj.find("input").val(k.value);
                                                    }
                                                });
                                            }
                                        });
                                    });
                                });
                            });
                        </script>
                    </div>
                    <div class="tab-pane fade" id="inf">
                        <div class="row mb10">
                            <div class="col-lg-12" style="text-align:left">
                                <textarea id="note" name="note" style="width:100%;height:200px;"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3"></div>
                <input id="hasSpec" name="hasSpec" type="hidden" value="0">
                <input id="products" name="products" type="hidden" value="">
                <input id="images" name="images" type="hidden" value="">
                <input id="spec_values" name="spec_values" type="hidden" value="[]">
                <input id="prop_values" name="prop_values" type="hidden" value="[]">
                <input id="param_values" name="param_values" type="hidden" value="[]">
        </form>

    </div>
</div>
<!-- 选择上级 -->
<div id="dialogSelectClass" class="modal fade bs-modal-sm" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h4 class="modal-title">选择分类</h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-xs-12">
                        <div id="jsTreeClass" class="demo"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="pull-left">
                    <button type="button" class="btn btn-success" data-dismiss="modal" onclick="selectFirstClass()">不限分类</button>
                </div>
                <button type="button" class="btn btn-default" data-dismiss="modal">取 消</button>
                <button type="button" class="btn btn-primary" onclick="selectClass()">确认选择</button>
            </div>
        </div>
    </div>
</div>
<div id="dialogLv" class="modal fade bs-modal-sm" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h4 class="modal-title">编辑会员价</h4>
            </div>
            <div class="modal-body">

                <%for(o in lvList){%>

                <div class="row mb10 lvpricecss"  data-lv-id="${o.id!}">
                    <div class="form-group">
                        <label for="dis_count" class="col-sm-3 control-label" style="padding-top: 10px;">${o.name!}</label>
                        <div class="col-sm-4">
                            <input type="text" class="form-control" style="width: 120px;" placeholder="">
                        </div>
                        <div id="dis_count" class="col-sm-3" style="padding-top: 10px;">
                            折扣率:${o.dis_count!}
                        </div>
                    </div>
                </div>
                <%}%>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="lvpriceSet()">确认</button>
            </div>
        </div>
    </div>
</div>
<div id="specHtml">
    <%if(obj.hasSpec){%>
    <div id="dialogSpec" class="modal fade" tabindex="-2" role="dialog" aria-hidden="true" style="display: none;">
        <div class="modal-dialog" style="width: 1000px;">
            <div class="modal-content" style="width: 1000px;">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h4 class="modal-title">商品规格</h4>
                </div>
                <div class="modal-body" style="min-height: 300px;">
                    <div class="row">
                        <div class="col-xs-12" style="float: left">
                            <% for(o in specList){ %>
                            <div class="spec" style="float: left;padding-right: 10px;" data-spec-name="${o.name!}" data-spec-type="${o.type!}" data-spec-id="${o.id!}">
                                <span class="h5 mb10" style="float: left"><input class="specChkAll" type="checkbox"><strong>${o.name!}:</strong></span>
                                <div style="float: left;padding-left: 20px;">
                                    <% for(v in o.specValues){ %>
                                    <div class="vl" >
                                        <input id="s${v.id!}" type="checkbox" value="${v.id!}"
                                               title="${v.spec_value!}"><%if(!isEmpty(v.spec_picurl)){%><img src="${v.spec_picurl!}" style="width: 12px;height: 12px;"><%}%>${v.spec_value!}

                                        <%if(o.type==1){%><a href="javascript:selImg('${v.id!}');" style="color: #428bca">选择图片</a><%}%>
                                        <div style="padding-left: 60px" id="s_img${v.id!}">

                                        </div>

                                    </div>
                                    <% }%>
                                </div>
                            </div>
                            <% } %>
                        </div>
                        <div class="col-xs-12" style="padding-top: 5px;height: 45px;">
                            <button id="doProduct" type="button" class="btn btn-primary btn-sm">生成所有货品</button>
                        </div>
                        <div style="width: 100%;text-align: center;margin-top: 10px;">
                            <table id="plist" class="table table-bordered table-striped table-condensed" style="width: 95%;margin: 20px;">
                                <thead>
                                <tr>
                                    <th>规格值</th>
                                    <th>货号</th>
                                    <th class="numeric">上架</th>
                                    <th class="numeric">库存</th>
                                    <th class="numeric">最小购买</th>
                                    <th class="numeric">最大购买</th>
                                    <th class="numeric">销售价</th>
                                    <th class="numeric" style="display: none">成本价</th>
                                    <th class="numeric">市场价</th>
                                    <th class="numeric">重量(g)</th>
                                    <th class="numeric">默认货品</th>
                                    <th class="numeric">操作</th>
                                </tr>
                                </thead>
                                <tbody>
                                <% for(o in obj.productsList){ %>
                                <tr><td>${o.spec!}<input name="productId" type="hidden" value="${o.id!}"></td>
                                    <td><input name="sku" type="text" class="form-control" value="${o.sku!}" style="height: 22px;width: 80px;padding: 0 2px;"></td>
                                    <td><input name="up" type="checkbox" <%if(!o.disabled){%>checked<%}%>></td>
                                    <td><input name="stock" type="text" value="${o.stock}" class="form-control" style="height: 22px;width: 60px;padding: 0 2px;"></td>
                                    <td><input name="buyMin" type="text" value="${o.buyMin}" class="form-control" style="height: 22px;width: 60px;padding: 0 2px;"></td>
                                    <td><input name="buyMax" type="text" value="${o.buyMax}" class="form-control" style="height: 22px;width: 60px;padding: 0 2px;"></td>
                                    <td style="text-align: left;width: 150px;">
                                        <div style="float: left"><input name="price" type="text" value="${@string.fenToYuan(o.price)}" class="form-control" style="height: 22px;width: 60px;padding: 0 2px;"></div>
                                        <div style="float: left"><input name="lvprice" type="hidden" value='${@string.toJson(o.lvPriceList),escape}'>
                                            <a class="member" href="javascript:;" style="color: #428bca">会员价</a></div></td>
                                    <td><input name="priceMarket" value="${@string.fenToYuan(o.priceMarket)}"  type="text" class="form-control" style="height: 22px;width: 60px;padding: 0 2px;"></td>
                                    <td style="display: none"><input name="priceCost" value="" type="text" class="form-control" style="height: 22px;width: 60px;padding: 0 2px;"></td>
                                    <td><input name="weight" value="${o.weight}"  type="text" class="form-control" style="height: 22px;width: 60px;padding: 0 2px;"></td>
                                    <td><input name="isDefault" type="checkbox" <%if(o.isDefault){%>checked<%}%>></td>
                                    <td><a class="delSpec" href="javascript:;" style="color: #428bca">删除</a></td></tr>
                                <%}%>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取 消</button>
                    <button id="dialogSpecOK" type="button" class="btn btn-primary" data-loading-text="保存...">保 存</button>
                </div>
            </div>
        </div>
    </div>
    <div id="dialogImg" class="modal fade" style="padding-top: 20px; display: none;" tabindex="-2" role="dialog" aria-hidden="true">
        <div class="modal-dialog" style="width: 650px;">
            <div class="modal-content" style="width: 650px;">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h4 class="modal-title">选择商品图片</h4>
                </div>
                <div class="modal-body">
                    <div class="row" id="dialogImg_imgs">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取 消</button>
                    <button id="specImgDelBtn" type="button" class="btn btn-danger" data-loading-text="删除...">删 除</button>

                </div>
            </div>
        </div>
    </div>
    <div id="dialogLvSpec" style="padding-top: 20px; display: none;" class="modal fade bs-modal-sm" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h4 class="modal-title">编辑会员价</h4>
                </div>
                <div class="modal-body">
                    <%for(o in lvList){%>

                    <div class="row mb10 lvpricecss"  data-lv-id="${o.id!}">
                        <div class="form-group">
                            <label for="dis_count2" class="col-sm-3 control-label" style="padding-top: 10px;">${o.name!}</label>
                            <div class="col-sm-4">
                                <input type="text" class="form-control" style="width: 120px;" placeholder="">
                            </div>
                            <div id="dis_count2" class="col-sm-3" style="padding-top: 10px;">
                                折扣率:${o.dis_count!}
                            </div>
                        </div>
                    </div>
                    <%}%>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal">确认</button>
                </div>
            </div>
        </div>
    </div>
    <script language="JavaScript">
        function specSelImg(id,url){
            $("#s_img"+id).html("<img class='specImg' src='"+url+"' style='height: 30px;width: 30px;'>");
            $("#dialogImg").modal("hide");
        }
        function specDelImg(id){
            $("#s_img"+id).html("");
        }
        function selImg(id){
            var imgs=getImg();
            $("#dialogImg_imgs").html("");
            $.each(imgs,function(i,o){
                var str="<div style='margin:2px;float:left;text-align: center;border: 1px solid #dcdcdc;cursor: pointer;' onclick=\"specSelImg('"+id+"','"+o.url+"')\" >" +
                        "<img src='" + o.url + "' style='width:100px;height: 80px;margin-bottom: 1px;'></div>";
                $("#dialogImg_imgs").append(str);
                $("#specImgDelBtn").unbind("click").on("click",function(){
                    specDelImg(id);
                    $("#dialogImg").modal("hide");
                });
            });
            $("#dialogImg").modal("show");
        }
        function getSpec(){
            var specs=[];
            $("#dialogSpec").find("div .spec").each(function(){
                var self=$(this);
                var spec={};
                var spec_values=[];
                spec.spec_name=$(this).attr("data-spec-name");
                spec.spec_type=$(this).attr("data-spec-type");
                spec.spec_id=$(this).attr("data-spec-id");

                self.find("div .vl").each(function(){
                    var v={};
                    v.spec_name=spec.spec_name;
                    v.spec_type=spec.spec_type;
                    v.spec_id=spec.spec_id;
                    var chk=false;
                    $(this).find("img[class='specImg']").each(function(){
                        v.spec_value_imgurl=$(this).attr("src");
                    });
                    $(this).find("input[type=checkbox]").each(function(){
                        v.spec_value_id=$(this).val();
                        v.spec_value_name=$(this).attr("title");
                        chk=$(this).prop("checked");
                    });
                    if(chk){
                        spec_values.push(v);
                        spec.spec_values=spec_values;
                    }
                });
                if(spec_values.length>0){
                    specs.push(spec);
                }

            });
            return specs;
        }
        function getProducts(specs) {
            if (!specs || specs.length == 0) {
                return [];
            } else {
                return joinSpec([[]], specs, 0, specs.length-1);
            }
            function joinSpec(prevProducts, specs, i, max) {
                var currentProducts = [], currentProduct, currentSpecs = specs[i];
                if ( i > max ) {
                    return prevProducts;
                }
                $.each(prevProducts,function(i,prevProduct) {
                    $.each(currentSpecs,function(j,spec) {
                        currentProduct = prevProduct.slice(0);
                        currentProduct.push(spec);
                        currentProducts.push(currentProduct);
                    });
                });
                return joinSpec(currentProducts, specs, ++i, max);
            }
        }
        $(document).ready(function () {
            //初始化商品设置的规格选项及规格图片
            var spec=${obj.spec!"[]"};
            $.each(spec,function (i,ss) {
                $.each(ss,function (j,s) {
                    if(s.spec_value_imgurl){
                        $("#s_img"+s.spec_value_id).html('<img class="specImg" src="'+s.spec_value_imgurl+'" style="height: 30px;width: 30px;">');
                    }
                    $("#s"+s.spec_value_id).prop('checked',true);

                });
            });
            $(".specChkAll").on("click",function(){
                if($(this).prop("checked")){
                    $(this).parent().parent().find("input[type=checkbox]").each(function(){
                        $(this).prop("checked",true);
                    });
                }else {
                    $(this).parent().parent().find("input[type=checkbox]").each(function(){
                        $(this).prop("checked",false);
                    });
                }
            });
            $("#doProduct").on("click",function(){
                var specs=getSpec();
                var product_name=[];
                var spec_values=[];
                var size=1;
                $.each(specs,function(i,s){
                    size=size * s.spec_values.length;
                    var t=[];
                    $.each(s.spec_values,function(j,o){
                        t.push(o);
                    });
                    spec_values.push(t);
                });
//      console.log('spec_values::'+JSON.stringify(spec_values));
                $.each(getProducts(spec_values),function(i,v){
                    var n="";
                    $.each(v,function(j,s){
                        n=n+ s.spec_name+":"+ s.spec_value_name;
                        if(j< v.length-1)n+="*";
                    });
                    product_name.push(n);
                });
                if(spec_values.length<1){
                    Toast.warning("至少选择一种规格");
                    return false;
                }
                //console.log("product_name::"+JSON.stringify(product_name));
                $("#plist tbody").html("");
                var i=0;
                var sku=$("#sku").val();
                var price=$("#price").val();
                var priceMarket=$("#priceMarket").val();
                var priceCost=$("#priceCost").val();
                var weight=$("#weight").val();
                $.each(product_name,function(i,name){
                    i++;
                    var str="<tr>";
                    var bn="";
                    if(sku!=""){
                        if(sku.indexOf("-")>0){
                            sku=sku.substring(0,sku.indexOf("-"));
                        }
                        bn=sku+"-"+i;
                    }
                    str+="<td>"+name+"<input name='productId' type='hidden'></td>";
                    str+="<td><input name='sku' type='text' class='form-control'  value='"+bn+"' style='height: 22px;width: 80px;padding: 0 2px;'></td>";
                    str+="<td><input name='up' type='checkbox' checked></td>";
                    str+="<td><input name='stock' type='text' class='form-control' style='height: 22px;width: 60px;padding: 0 2px;'></td>";
                    str+="<td><input name='buyMin' type='text' class='form-control' style='height: 22px;width: 60px;padding: 0 2px;'></td>";
                    str+="<td><input name='buyMax' type='text' class='form-control' style='height: 22px;width: 60px;padding: 0 2px;'></td>";
                    str+="<td style='text-align: left;width: 150px;'><div style='float: left'><input name='price' type='text' value='"+price+"' class='form-control' style='height: 22px;width: 60px;padding: 0 2px;'></div><div style='float: left'>" +
                            "<input name='lvprice' type='hidden' value='[]'><a class='member' href='javascript:;' style='color: #428bca'>会员价</a></div></td>";
                    str+="<td><input name='priceMarket' value='"+priceMarket+"' type='text' class='form-control' style='height: 22px;width: 60px;padding: 0 2px;'></td>";
                    str+="<td style='display: none'><input name='priceCost[]' value='"+priceCost+"' type='text' class='form-control' style='height: 22px;width: 60px;padding: 0 2px;'></td>";
                    str+="<td><input name='weight' value='"+weight+"' type='text' class='form-control' style='height: 22px;width: 60px;padding: 0 2px;'></td>";
                    str+="<td><input name='isDefault' type='checkbox'></td>";
                    str+="<td><a class='delSpec' href='javascript:;' style='color: #428bca'>删除</a></td>";
                    $("#plist tbody").append(str);
                });
                $("#plist .delSpec").on("click",function(){
                    $(this).parent().parent().remove();
                });
                $("#plist .member").on("click",function(){
                    var self=$(this).parent().find("input[type=hidden]");
                    var lvprice=self.val();
                    if(lvprice!=""&&lvprice!="[]"){
                        var lvp=JSON.parse(lvprice);
                        $.each(lvp,function(i,lv){
                            var j=0;
                            $("#dialogLvSpec").find("input[type=text]").each(function(){
                                if(i==j)$(this).val(lv.lvPrice);
                                j++;
                            });
                        });
                    }else {
                        $("#dialogLvSpec").find("input[type=text]").each(function(){
                            $(this).val("");
                        });
                    }
                    $("#dialogLvSpec button[type=button]").unbind("click").on("click",function(){
                        var lv=[];
                        $("#dialogLvSpec").find(".lvpricecss").each(function(){
                            var id=$(this).attr("data-lv-id");
                            var price=$(this).find("input[type=text]").val();
                            if(price!="")
                                lv.push({'lvId':id,'lvPrice':price});
                        });
                        self.val(JSON.stringify(lv));
                    });
                    $("#dialogLvSpec").modal("show");
                });
            });
            $("#dialogSpecOK").on("click",function(){
                var is_default=0;
                $("#plist tbody").find("input[name='isDefault']").each(function(){
                    if($(this).prop("checked"))is_default++;
                });
                if(is_default==1){
                    var specs=getSpec();
                    var spec_values=[];
                    var size=1;
                    $.each(specs,function(i,s){
                        size=size * s.spec_values.length;
                        var t=[];
                        $.each(s.spec_values,function(j,o){
                            t.push(o);
                        });
                        spec_values.push(t);
                    });
                    $("#spec_values").val(JSON.stringify(spec_values));
                    var specs=[];
                    var specs_name="";
                    $("#plist tbody").find("tr").each(function(){
                        var self=$(this);
                        var spec=self.find("td:first").text();
                        specs_name+=spec+"|";
                        var productId=self.find("input[name='productId']").val();
                        var sku=self.find("input[name='sku']").val();
                        var disabled=self.find("input[name='up']").prop("checked")==false;
                        var stock=self.find("input[name='stock']").val();
                        var buyMin=self.find("input[name='buyMin']").val();
                        var buyMax=self.find("input[name='buyMax']").val();
                        var price=self.find("input[name='price']").val();
                        var lvprice=self.find("input[name='lvprice']").val();
                        var priceMarket=self.find("input[name='priceMarket']").val();
                        var priceCost=self.find("input[name='priceCost']").val();
                        var weight=self.find("input[name='weight']").val();
                        var isDefault=self.find("input[name='isDefault']").prop("checked")==true;
                        specs.push({'id':productId,'spec':spec,'sku':sku,'disabled':disabled,'stock':stock,'buyMin':buyMin,'buyMax':buyMax,'price':price,
                            'lvprice':JSON.parse(lvprice),'priceMarket':priceMarket,'priceCost':priceCost,'weight':weight,'isDefault':isDefault});
                    });
                    $("#hasSpec").val("1");
                    $("#specs").val(JSON.stringify(specs));
                    $("#sp").hide();
                    $("#sp_new").html('<div class="form-group" id="gg_new">'+
                            '<label for="gg_new" class="col-sm-2 control-label">规格</label>'+
                            '<div class="col-sm-8">'+
                            '<button id="specEditBtn" class="btn btn-primary" style="float: left;" type="button">编辑规格</button>'+
                            '<div style="float: left;text-align: left;">已设置'+specs.length+'个规格货品['+ specs_name+']</div>'+
                            '</div>'+
                            '</div>').show();
                    $("#specEditBtn").unbind("click").on("click",function(){
                        $("#dialogSpec").modal("show");
                    });
                    $("#dialogSpec").modal("hide");
                }else {
                    Toast.warning("请选择一个货品为默认货品");
                    return false;
                }
            });
        });
    </script>
    <%}%>
</div>
<script language="JavaScript">
    var imgId=0;
    var ue;
    function initTreeView() {
        $("#jsTreeClass").jstree({
            plugins: ["wholerow", "json_data"],
            core: {
                data: {
                    dataType: "json",
                    url: function (node) {
                        return node.id === "#" ? "${base!}/platform/shop/goods/class/tree" : "${base!}/platform/shop/goods/class/tree?pid=" + node.id
                    }
                },
                multiple: false
            }
        }).on("dblclick.jstree", function (node) {
            selectClass();
        });
    }
    function getProps(id){
        $.post("${base!}/platform/shop/goods/goods/getProps/" + id, {}, function (propdata) {
            if(propdata.code==0){
                var str='';
                $.each(propdata.data,function(i,prop){
                    if(prop.type=='select'){
                        str+='<div class="form-group">';
                        str+='<label class="col-sm-2 control-label">'+prop.name+'</label>';
                        str+='<div class="col-sm-8">';
                        str+='<select class="form-control" >';
                        str+='<option value=""></option>';
                        $.each(prop.propsValues,function(j,value){
                            str+='<option value="'+value.name+'">'+value.name+'</option>';
                        });
                        str+='</select>';
                        str+='</div>';
                        str+='</div>';
                    }else {
                        str+='<div class="form-group">';
                        str+='<label class="col-sm-2 control-label">'+prop.name+'</label>';
                        str+='<div class="col-sm-8">';
                        str+='<input class="form-control" />';
                        str+='</div>';
                        str+='</div>';
                    }
                });
                $("#kzsx").html(str);
            }else {
                $("#kzsx").html('');
            }
        }, "json");
    }
    function getParam(id){
        $.post("${base!}/platform/shop/goods/goods/getParam/" + id, {}, function (paramdata) {
            if(paramdata.code==0){
                var str='';
                $.each(paramdata.data,function(i,param){
                    str+='<div class="form-group">';
                    str+='<label class="col-sm-3 control-label">'+param.name+'</label>';
                    $.each(param.params,function(j,k) {
                        str += '<div class="col-sm-12" style="padding-bottom:5px;"><div class="col-sm-10 input-group"><span class="input-group-btn"><button class="btn" style="width:120px;" type="button">'+ k.name+'</button>';
                        str += '</span><input type="text" class="form-control" placeholder="'+ k.name+'"></div></div>';
                    });
                    str+='</div>';

                });
                $("#xxcs").html(str);
            }else {
                $("#xxcs").html('');
            }
        }, "json");
    }
    function getBrand(id){
        $.post("${base!}/platform/shop/goods/goods/getBrand/" + id, {}, function (branddata) {
            if(branddata.code==0){
                var str='';
                $("#brandId").append('<option value=""></option>');
                $.each(branddata.data,function(i,brand){
                    $("#brandId").append('<option value="'+brand.brandId+'">'+brand.brand.name+'</option>');
                });
            }
        }, "json");
    }
    function getType(id) {
        if(id==''){
            $("#kzsx_tab").hide();
            $("#xxcs_tab").hide();
            $("#gg").hide();
            $("#kzsx").html('');
            $("#sp_new").html('').hide();
            $("#sp").show();
            $("#hasSpec").val("0");
            $("#products").val('[]');
            $("#spec_values").val('[]');
            $("#param_values").val('[]');
            $("#prop_values").val('[]');
            $("#brandId").find("option").remove();
        }else {
            getBrand(id);
            $.post("${base!}/platform/shop/goods/goods/getType/" + id, {}, function (data) {
                if(data.code==0){
                    $("#sp_new").html('').hide();
                    $("#sp").show();
                    $("#hasSpec").val("0");
                    $("#products").val('[]');
                    $("#spec_values").val('[]');
                    $("#param_values").val('[]');
                    $("#prop_values").val('[]');
                    if(data.data.hasProp){
                        $("#kzsx_tab").show();
                        getProps(data.data.id);
                    }else{
                        $("#kzsx_tab").hide();
                    }
                    if(data.data.hasParam){
                        $("#xxcs_tab").show();
                        getParam(data.data.id);
                    }else{
                        $("#xxcs_tab").hide();
                    }
                    if(data.data.hasSpec){
                        $("#gg").show();
                    }else{
                        $("#gg").hide();
                    }
                }else{
                    Toast.error(data.msg);
                }
            }, "json");
        }
    }
    //选择商品分类
    function selectClass() {
        var tree = $.jstree.reference("#jsTreeClass");
        var node = tree.get_selected(true);
        var id=node[0].id;
        $("#addForm #classId").val(node[0].text);
        $("#addForm input[name='classId']").val(id);
        $("#dialogSelectClass").modal("hide");
        $("#brandId").find("option").remove();
        $.post("${base!}/platform/shop/goods/goods/getClass/" + id, {}, function (data) {
            if(data.code==0){
                var type=data.data.goodsType;
                if(type){
                    $("#typeId option[value='"+type.id+"']").attr("selected", true);
                    if(type.hasBrand){
                        getBrand(type.id);
                    }
                    if(type.hasProp){
                        $("#kzsx_tab").show();
                        getProps(type.id);
                    }else{
                        $("#kzsx_tab").hide();
                    }
                    if(type.hasParam){
                        $("#xxcs_tab").show();
                        getParam(type.id);
                    }else{
                        $("#xxcs_tab").hide();
                    }
                    if(type.hasSpec){
                        $("#gg").show();
                    }else{
                        $("#gg").hide();
                    }
                }else {
                   $("#typeId").val("");
                }
            }else{
                Toast.error(data.msg);
            }
        }, "json");
    }
    function selectFirstClass() {
        $("#addForm #classId").val("请选择商品分类");
        $("#addForm input[name='classId']").val("");
        $("#dialogSelectClass").modal("hide");
    }
    function setImg(id){
        $("#img").find("div").each(function(){
            $(this).removeClass("divImgD").addClass("divImg");
        });
        $("#"+id).removeClass("divImg");
        $("#"+id).addClass("divImgD");
    }
    function delImg(id){
        $("#"+id).remove();
    }
    function getImg(){
        var imgs=[];

        $("#img").find("div").each(function(){
            var img={};
            img.d=false;
            if($(this).hasClass("divImgD")){
                img.d=true;
            }
            $(this).find("img").each(function(){
                img.url=$(this).attr("src");
            });
            imgs.push(img);
        });
        return imgs;
    }
    function lvpriceSet(){
        var lv=[];
        var self=$("#sp").find("input[type=hidden]");
        $("#dialogLv").find(".lvpricecss").each(function(){
            var id=$(this).attr("data-lv-id");
            var price=$(this).find("input[type=text]").val();
            if(price!="")
                lv.push({'lv_id':id,'lv_price':price});
        });
        self.val(JSON.stringify(lv));
        $("#dialogLv").modal("hide");
    }
    $(document).ready(function () {
        setTimeout(function () {
            ue = new baidu.editor.ui.Editor();
            ue.render('note');
        }, 500);
        $("#typeId").on("change",function(){
            getType($(this).val());
        });
        $("#specBtn").on("click",function(){
            if($("#sku").val()==""){
                Toast.warning("开启规格必须先填写货号");
                $("#sku").focus();
                return false;
            }
            $("#specHtml").load("${base!}/platform/shop/goods/goods/spec/"+$("#typeId").val()+"/"+$("#sku").val(), function (response, status, xhr) {
                $("#dialogSpec").modal("show");
            });
        });
        <%if(obj.hasSpec){%>
            //start spec
            //重新格式化会员价格信息（不启用规格）
            var self0=$("#sp").find("input[name='lvprice']");
            var lvprice0=self0.val();
            if(lvprice0!="[]"&&lvprice0!="") {
                var lvList0 = JSON.parse(lvprice0);
                var newList0 = [];
                $.each(lvList0, function (i, o) {
                    var newObj = {};
                    newObj.lvId = o.lvId;
                    newObj.lvPrice = setPrice(o.lvPrice);
                    newList0.push(newObj);
                });
                self0.val(JSON.stringify(newList0));
            }
            //重新格式化会员价格信息（启用规格）
            $("#plist tbody").find("tr").each(function(){
                var self=$(this).find("input[name='lvprice']");
                var lvprice=self.val();
                if(lvprice!="[]"&&lvprice!=""){
                    var lvList=JSON.parse(lvprice);
                    var newList=[];
                    $.each(lvList,function(i,o){
                        var newObj={};
                        newObj.lvId=o.lvId;
                        newObj.lvPrice=setPrice(o.lvPrice);
                        newList.push(newObj);
                    }) ;
                    self.val(JSON.stringify(newList));
                }
            });
            $("#specEditBtn").unbind("click").on("click",function(){
                $("#dialogSpec").modal("show");
            });
            $("#dialogSpecOK").trigger("click");
            $("#plist .delSpec").on("click",function(){
                $(this).parent().parent().remove();
            });
            $("#plist .member").on("click",function(){
            var self=$(this).parent().find("input[type=hidden]");
            var lvprice=self.val();
            if(lvprice!=""&&lvprice!="[]"){
            var lvp=JSON.parse(lvprice);
            $.each(lvp,function(i,lv){
            var j=0;
            $("#dialogLvSpec").find("input[type=text]").each(function(){
            if(i==j)$(this).val(lv.lvPrice);
            j++;
        });
        });
        }else {
            $("#dialogLvSpec").find("input[type=text]").each(function(){
            $(this).val("");
        });
        }
            $("#dialogLvSpec button[type=button]").unbind("click").on("click",function(){
            var lv=[];
            $("#dialogLvSpec").find(".lvpricecss").each(function(){
            var id=$(this).attr("data-lv-id");
            var price=$(this).find("input[type=text]").val();
            if(price!="")
            lv.push({'lvId':id,'lvPrice':price});
        });
            self.val(JSON.stringify(lv));
        });
            $("#dialogLvSpec").modal("show");
        });
            //end spec
            <%}%>
        initTreeView();
        var container = document.getElementById("img");
        var sort = Sortable.create(container);
        $('#file_upload').uploadifive({
            'auto': true,
            'multi': true,
            'width': '100%',
            'height': '35',
            'buttonText': '请选择图片',
            'fileType': 'image/jpg,image/jpeg,image/png',
            'fileSizeLimit': 1024,
            'queueSizeLimit': 6,
            'formData': {},
            'queueID': 'queue',
            'uploadScript': '${base!}/open/file/upload/dbimage',
            'onUploadComplete': function (file, data) {
                data = JSON.parse(data);
                if (data.code == 0) {
                    Toast.success(data.msg);
                    imgId++;
                    var c="divImg";
                    if(imgId==1){
                        c="divImgD";
                    }
                    $("#img").append("<div id='imgId"+imgId+"' class='"+c+"'>" +
                            "<img  onclick=\"setImg('imgId"+imgId+"')\" src='" + data.data+ "' style='width:100px;height: 80px;margin-bottom: 1px;'><br>" +
                            "<i style='float: right;padding-top: 4px;' class='fa fa-close' onclick=\"delImg('imgId"+imgId+"')\"></i></div>");
                    sort.destroy();
                    sort = Sortable.create(container);
                } else {
                    Toast.error(data.msg);
                }
            },
            'onSelect' : function(queue) {
                if($("#img").children().length>5){
                    Toast.warning("最大允许上传6张图片");
                    $('#file_upload').uploadifive('cancel', $('.uploadifive-queue-item').first().data('file'));
                }
            }
        });
        $("#save").on("click",function(){
            if ($("#hasSpec").val() == "0") {
                var specs = [];
                var self = $("#sp");
                var spec = "";
                var sku = self.find("input[name='sku']").val();
                var disabled = false;
                var name = self.find("input[name='name']").val();
                var title = self.find("input[name='title']").val();
                var stock = self.find("input[name='stock']").val();
                var buyMin = self.find("input[name='buyMin']").val();
                var buyMax = self.find("input[name='buyMax']").val();
                var price = self.find("input[name='price']").val();
                var lvprice = self.find("input[name='lvprice']").val()||[];
                var priceMarket = self.find("input[name='priceMarket']").val();
                var weight = self.find("input[name='weight']").val();
                var isDefault = true;
                specs.push({
                    'spec': spec,
                    'sku': sku,
                    'disabled': disabled,
                    'name': name,
                    'title': title,
                    'stock': stock,
                    'buyMin': buyMin,
                    'buyMax': buyMax,
                    'price': price,
                    'lvprice': JSON.parse(lvprice),
                    'priceMarket': priceMarket,
                    'weight': weight,
                    'isDefault': isDefault
                });
                $("#products").val(JSON.stringify(specs));
            }
            var props=[];
            $("#kzsx").find(".form-group").each(function(){
                var self=$(this);
                var obj={};
                obj.name=self.find("label").text();
                obj.value=self.find("select").val()||self.find("input").val()||'';
                props.push(obj);
            });
            var params=[];
            $("#xxcs").find(".form-group").each(function(){
                var self=$(this);
                var group=[];
                var obj={};
                obj.name=self.find("label").text();
                self.find(".col-sm-12").each(function(){
                    var o={};
                    o.name=$(this).find(".btn").text();
                    o.value=$(this).find("input").val();
                    group.push(o);
                });
                obj.value=group;
                params.push(obj);
            });
            //console.log('params::'+JSON.stringify(params));
            $("#images").val(JSON.stringify(getImg()));
            $("#prop_values").val(JSON.stringify(props));
            $("#param_values").val(JSON.stringify(params));
            if($("#isSubmit").val()=="1"){
                Toast.error("请勿重复提交");
            }else{
                $('#addForm').submit();
            }
        });
        $('#addForm').ajaxForm({
            dataType: 'json',
            beforeSubmit: function (arr, form, options) {
                form.find("button:submit").button("loading");
                $("#isSubmit").val("1");
            },
            success: function (data, statusText, xhr, form) {
                if (data.code == 0) {
                    $("#addForm").attr("action","${base!}/platform/shop/goods/goods/editDo");
                    $("#id").val(data.data);
                    Toast.success(data.msg);
                } else {
                    Toast.error(data.msg);
                }
                $("#isSubmit").val("0");
                form.find("button:submit").button("reset");
            }
        });
    });
</script>


<%}%>